#!/bin/bash
set -euo pipefail
. config/env

HEADER="### GENERATED BY mk_tinc_conf - DO NOT EDIT ###"

cat <<EOF > packer/files/etc/tinc/default/tinc.conf
$HEADER
Name = \$HOST
AddressFamily = ipv4
Interface = tun0
EOF

for ((i=0;i<SERVERS;i++)); do
	CD="config/master${i}"
	if [[ -e "$CD/rsa_key.priv" ]]; then
		echo "$CD/rsa_key.priv already exists, skipping"
		continue
	fi
	mkdir -p "$CD/hosts"
	cp "packer/files/etc/tinc/default/tinc.conf" "$CD/"
	tincd -n default -K -c "$CD" -o "Name=master${i}" < /dev/null
	(
		cat <<-EOF
		$HEADER
		Address = master$i.$DOMAIN
		Subnet = $IP_INT_PREFIX.$i.0/24
		EOF
		cat "$CD/hosts/master${i}"
	) > "packer/files/etc/tinc/default/hosts/master${i}"
	rm "$CD/tinc.conf"
	echo "ConnectTo = master${i}" >> packer/files/etc/tinc/default/tinc.conf
done
