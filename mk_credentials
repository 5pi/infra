#!/bin/bash
set -euo pipefail
. config/env

HEADER="### GENERATED BY $0 - DO NOT EDIT ###"

# Tinc
cat <<EOF > packer/files/etc/tinc/default/tinc.conf

EOF

mkdir -p config/generated
for ((i=0;i<SERVERS;i++)); do
	CD="config/generated/tinc/master${i}"
	if [[ -e "$CD/rsa_key.priv" ]]; then
		echo "$CD/rsa_key.priv already exists, skipping"
		continue
	fi
	mkdir -p "$CD"
	touch $CD/tinc.conf
	tincd -n default -K -c "$CD" < /dev/null
	rm "$CD/tinc.conf"
done

mkdir -p config/generated/ca
if [[ -e "config/generated/ca/ca.pem" ]]; then
	echo "config/generated/ca/ca.pem already exists, skipping"
else
	cfssl gencert -initca config/ca/ca-csr.json | cfssljson -bare config/generated/ca -
fi
for ((i=0;i<SERVERS;i++)); do
	prefix="config/generated/master$i"
	if [[ -e "$prefix.pem" ]]; then
		echo "$prefix.pem already exists, skipping"
		continue
	fi
	echo '{"CN":"master${i}","hosts":[""],"key":{"algo":"rsa","size":2048}}' \
		| cfssl gencert -ca=config/generated/ca.pem -ca-key=config/generated/ca-key.pem -config=config/ca/ca-config.json -profile=server -hostname="master${i}" - \
		| cfssljson -bare "$prefix"
done
